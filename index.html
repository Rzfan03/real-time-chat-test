<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Social</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --error-color: #ea4335;
            --warning-color: #fbbc05;
            --dark-gray: #5f6368;
            --medium-gray: #80868b;
            --light-gray: #f1f3f4;
            --white: #ffffff;
            --black: #202124;
            --shadow: 0 1px 2px rgba(0,0,0,0.1);
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--black);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
            max-width: 100%;
            margin: 0;
            flex-direction: column;
        }

        /* Sidebar styles */
        .sidebar {
            width: 100%;
            background-color: var(--white);
            padding: 15px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .profile-section {
            display: flex;
            align-items: center;
        }

        .profile-pic {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            margin-right: 10px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }

        .profile-name {
            font-weight: 500;
            font-size: 14px;
            display: none;
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            color: var(--dark-gray);
            font-size: 20px;
            cursor: pointer;
            display: block;
        }

        .nav-menu {
            list-style: none;
            display: none;
            position: absolute;
            top: 70px;
            left: 0;
            right: 0;
            background-color: var(--white);
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-menu.active {
            display: block;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: var(--border-radius);
            color: var(--dark-gray);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--light-gray);
            color: var(--primary-color);
        }

        .nav-link svg {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }

        .friend-requests-badge {
            background-color: var(--error-color);
            color: var(--white);
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: auto;
        }

        /* Main content styles */
        .main-content {
            flex: 1;
            padding: 15px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .page-title {
            font-size: 20px;
            font-weight: 500;
        }

        .create-post-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .create-post-btn svg {
            margin-right: 5px;
        }

        /* Post creation styles */
        .post-creator {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }

        .post-input {
            width: 100%;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 10px;
            margin-bottom: 10px;
            resize: none;
            min-height: 80px;
            font-size: 14px;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-action-btn {
            background: none;
            border: none;
            color: var(--medium-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 5px;
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .post-action-btn:hover {
            background-color: var(--light-gray);
        }

        .post-action-btn svg {
            margin-right: 5px;
        }

        .post-submit-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .image-preview-container {
            margin-top: 10px;
            position: relative;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--border-radius);
        }

        .remove-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--error-color);
            color: var(--white);
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Posts styles */
        .posts-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .post {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .post-user {
            font-weight: 500;
            font-size: 15px;
        }

        .post-time {
            font-size: 12px;
            color: var(--medium-gray);
        }

        .post-content {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .post-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
        }

        .post-actions-bar {
            display: flex;
            border-top: 1px solid var(--light-gray);
            border-bottom: 1px solid var(--light-gray);
            padding: 8px 0;
            margin-bottom: 10px;
        }

        .post-action {
            display: flex;
            align-items: center;
            margin-right: 10px;
            color: var(--medium-gray);
            cursor: pointer;
            padding: 5px;
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .post-action:hover {
            background-color: var(--light-gray);
        }

        .post-action.liked {
            color: var(--error-color);
        }

        .post-action svg {
            margin-right: 5px;
        }

        .post-action-count {
            margin-left: 3px;
            font-size: 12px;
        }

        .comments-section {
            margin-top: 10px;
        }

        .comments-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .comment {
            display: flex;
            margin-bottom: 10px;
        }

        .comment-user {
            font-weight: 500;
            font-size: 13px;
        }

        .comment-content {
            font-size: 13px;
            margin: 3px 0;
        }

        .comment-time {
            font-size: 11px;
            color: var(--medium-gray);
        }

        .comment-actions {
            display: flex;
            margin-top: 3px;
        }

        .comment-action {
            font-size: 11px;
            color: var(--medium-gray);
            margin-right: 8px;
            cursor: pointer;
        }

        .comment-action:hover {
            text-decoration: underline;
        }

        .comment-input-container {
            display: flex;
            margin-top: 8px;
        }

        .comment-input {
            flex: 1;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 8px;
            font-size: 14px;
        }

        .comment-button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 12px;
            margin-left: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-post {
            background: none;
            border: none;
            color: var(--medium-gray);
            font-size: 18px;
            cursor: pointer;
            margin-left: auto;
        }

        .delete-post:hover {
            color: var(--error-color);
        }

        /* Chat styles */
        .chat-container {
            display: none;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            height: calc(100vh - 120px);
            position: relative;
            margin-bottom: 15px;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--light-gray);
        }

        .chat-back-button {
            background: none;
            border: none;
            margin-right: 10px;
            cursor: pointer;
            display: none;
        }

        .chat-title {
            font-weight: 500;
            font-size: 16px;
        }

        .chat-messages {
            padding: 12px;
            height: calc(100% - 120px);
            overflow-y: auto;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .message-sender {
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .message-content {
            background-color: var(--light-gray);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            max-width: 80%;
            word-wrap: break-word;
            font-size: 14px;
            position: relative;
        }

        .message-time {
            font-size: 10px;
            color: var(--medium-gray);
            margin-top: 3px;
        }

        .current-user-message .message-content {
            background-color: var(--primary-color);
            color: var(--white);
            align-self: flex-end;
        }

        .current-user-message .message-sender {
            align-self: flex-end;
        }

        .current-user-message .message-time {
            align-self: flex-end;
        }

        .message-actions {
            position: absolute;
            right: 0;
            top: 0;
            display: none;
        }

        .message:hover .message-actions {
            display: block;
        }

        .message-action {
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 5px;
        }

        .message-action:hover {
            background: rgba(0,0,0,0.2);
        }

        .reply-indicator {
            font-size: 12px;
            color: var(--medium-gray);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .reply-indicator svg {
            margin-right: 5px;
        }

        .reply-preview {
            background-color: rgba(0,0,0,0.05);
            border-left: 3px solid var(--primary-color);
            padding: 5px 8px;
            margin-bottom: 5px;
            border-radius: 0 4px 4px 0;
            font-size: 12px;
            max-width: 80%;
        }

        .chat-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            flex-direction: column;
        }

        .reply-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--light-gray);
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .cancel-reply {
            background: none;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            font-size: 12px;
        }

        .chat-input-wrapper {
            display: flex;
        }

        .chat-input {
            flex: 1;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 10px;
            resize: none;
            font-size: 14px;
        }

        .chat-send-button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 15px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Users list styles */
        .users-list-container {
            display: none;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
        }

        .users-list-title {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            cursor: pointer;
        }

        .user-item:hover {
            background-color: var(--light-gray);
        }

        .friend-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: var(--border-radius);
            margin-left: auto;
        }

        .friend-status.friends {
            color: var(--secondary-color);
            background-color: rgba(52, 168, 83, 0.1);
        }

        .friend-status.pending {
            color: var(--warning-color);
            background-color: rgba(251, 188, 5, 0.1);
        }

        .friend-status.add {
            color: var(--primary-color);
            background-color: rgba(66, 133, 244, 0.1);
            cursor: pointer;
            border: none;
        }

        /* Friends list styles */
        .friends-list-container {
            display: none;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
        }

        .friends-list-title {
            font-size: 18px;
            margin-bottom: 10px;
        }

        /* Friend requests styles */
        .friend-requests-container {
            display: none;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
        }

        .friend-requests-title {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .friend-request {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            background-color: var(--light-gray);
        }

        .friend-request-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }

        .friend-request-btn {
            border: none;
            padding: 5px 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
        }

        .accept-btn {
            background-color: var(--secondary-color);
            color: var(--white);
        }

        .reject-btn {
            background-color: var(--error-color);
            color: var(--white);
        }

        /* Profile editor styles */
        .profile-editor-container {
            display: none;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
        }

        .profile-editor-title {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .profile-form-group {
            margin-bottom: 12px;
        }

        .profile-form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .profile-form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .profile-photo-preview-container {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .profile-photo-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 12px;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            background-color: var(--primary-color);
        }

        .profile-photo-upload-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
        }

        .profile-save-btn {
            background-color: var(--secondary-color);
            color: var(--white);
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
            width: 100%;
            font-size: 14px;
        }

        /* User profile view styles */
        .user-profile-container {
            display: none;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
        }

        .user-profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 15px;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            font-size: 32px;
        }

        .user-profile-info {
            flex: 1;
        }

        .user-profile-name {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .user-profile-status {
            font-size: 14px;
            color: var(--medium-gray);
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .user-profile-actions {
            margin-top: 10px;
        }

        .user-profile-action-btn {
            padding: 8px 15px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .user-profile-action-btn.primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .user-profile-action-btn.secondary {
            background-color: var(--light-gray);
            color: var(--black);
            margin-left: 10px;
        }

        .user-posts-title {
            font-size: 18px;
            margin: 20px 0 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
        }

        .user-posts-container {
            margin-top: 15px;
        }

        /* Empty state styles */
        .empty-state {
            text-align: center;
            color: var(--medium-gray);
            padding: 20px;
            font-size: 14px;
        }

        /* Hidden utility class */
        .hidden {
            display: none !important;
        }

        /* Online status indicator */
        .online-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
            vertical-align: middle;
        }

        .online-status.online {
            background-color: var(--secondary-color);
        }

        .online-status.offline {
            background-color: var(--medium-gray);
        }

        /* Last online time */
        .last-online {
            font-size: 11px;
            color: var(--medium-gray);
            margin-left: 5px;
        }

        /* User status in chat */
        .user-status {
            font-size: 12px;
            color: var(--medium-gray);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        /* Active now indicator */
        .active-now {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--secondary-color);
            margin-left: 5px;
        }

        .active-now .pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--secondary-color);
            margin-right: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 5px rgba(52, 168, 83, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(52, 168, 83, 0);
            }
        }

        /* Desktop styles */
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                max-width: 1200px;
                margin: 0 auto;
            }

            .sidebar {
                width: 250px;
                height: 100vh;
                position: fixed;
                flex-direction: column;
                align-items: flex-start;
                justify-content: flex-start;
            }

            .profile-section {
                margin-bottom: 30px;
                padding-bottom: 15px;
                border-bottom: 1px solid var(--light-gray);
                width: 100%;
            }

            .profile-name {
                display: block;
            }

            .mobile-menu-btn {
                display: none;
            }

            .nav-menu {
                display: block;
                position: static;
                box-shadow: none;
                padding: 0;
                margin-bottom: 30px;
            }

            .main-content {
                margin-left: 250px;
                padding: 20px;
            }

            .chat-container {
                height: calc(100vh - 100px);
            }

            .users-list-container,
            .friends-list-container,
            .friend-requests-container,
            .user-profile-container {
                height: calc(100vh - 100px);
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Simple Social</div>
            </div>
            
            <button class="mobile-menu-btn" id="mobile-menu-btn">☰</button>
            
            <div class="profile-section">
                <div class="profile-pic" id="sidebar-profile-pic">U</div>
                <div>
                    <div class="profile-name" id="sidebar-profile-name">User</div>
                </div>
            </div>
            
            <ul class="nav-menu" id="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" id="nav-home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        Home
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="nav-chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        Chat
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="nav-friends">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Friends
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="nav-friend-requests">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        Friend Requests
                        <span class="friend-requests-badge hidden" id="friend-requests-badge">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="nav-profile">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Profile
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Home View -->
            <div id="home-view">
                <div class="header">
                    <h1 class="page-title">Home</h1>
                    <button class="create-post-btn" id="create-post-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Create Post
                    </button>
                </div>
                
                <!-- Post Creator -->
                <div class="post-creator hidden" id="post-creator">
                    <textarea class="post-input" id="post-input" placeholder="What's on your mind?"></textarea>
                    <div class="image-preview-container hidden" id="image-preview-container">
                        <img src="" alt="Preview" class="image-preview" id="image-preview">
                        <button class="remove-image-btn" id="remove-image-btn">×</button>
                    </div>
                    <div class="post-actions">
                        <div>
                            <button class="post-action-btn" id="add-image-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                Photo
                            </button>
                            <input type="file" id="image-upload" accept="image/*" class="hidden">
                        </div>
                        <button class="post-submit-btn" id="post-submit-btn">Post</button>
                    </div>
                </div>
                
                <!-- Posts Container -->
                <div class="posts-container" id="posts-container"></div>
            </div>
            
            <!-- Chat View -->
            <div class="chat-container" id="chat-view">
                <div class="chat-header">
                    <button class="chat-back-button" id="chat-back-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                    </button>
                    <h2 class="chat-title" id="chat-title">Public Chat</h2>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-container">
                    <div class="reply-info hidden" id="reply-info">
                        <span>Replying to <span id="reply-to-name"></span></span>
                        <button class="cancel-reply" id="cancel-reply">Cancel</button>
                    </div>
                    <div class="chat-input-wrapper">
                        <textarea class="chat-input" id="chat-input" placeholder="Type a message..."></textarea>
                        <button class="chat-send-button" id="chat-send-button">Send</button>
                    </div>
                </div>
            </div>
            
            <!-- Users List View -->
            <div class="users-list-container" id="users-list-view">
                <h2 class="users-list-title">Online Users</h2>
                <div id="users-list-container"></div>
            </div>
            
            <!-- Friends List View -->
            <div class="friends-list-container" id="friends-list-view">
                <h2 class="friends-list-title">Friends</h2>
                <div id="friends-list-container"></div>
            </div>
            
            <!-- Friend Requests View -->
            <div class="friend-requests-container" id="friend-requests-view">
                <h2 class="friend-requests-title">Friend Requests</h2>
                <div id="friend-requests-container"></div>
            </div>
            
            <!-- Profile Editor View -->
            <div class="profile-editor-container" id="profile-view">
                <h2 class="profile-editor-title">Edit Profile</h2>
                <div class="profile-photo-preview-container">
                    <div class="profile-photo-preview" id="profile-photo-preview"></div>
                    <button class="profile-photo-upload-btn" id="profile-photo-upload-btn">Upload Photo</button>
                    <input type="file" id="profile-photo-upload" accept="image/*" class="hidden">
                </div>
                <div class="profile-form-group">
                    <label for="profile-name-input" class="profile-form-label">Name</label>
                    <input type="text" class="profile-form-input" id="profile-name-input" placeholder="Your name">
                </div>
                <div class="profile-form-group">
                    <label for="profile-email-input" class="profile-form-label">Email</label>
                    <input type="email" class="profile-form-input" id="profile-email-input" placeholder="your@email.com">
                </div>
                <button class="profile-save-btn" id="profile-save-btn">Save Changes</button>
            </div>
            
            <!-- User Profile View -->
            <div class="user-profile-container" id="user-profile-view">
                <div class="user-profile-header">
                    <div class="user-profile-pic" id="user-profile-pic"></div>
                    <div class="user-profile-info">
                        <div class="user-profile-name" id="user-profile-name"></div>
                        <div class="user-profile-status" id="user-profile-status"></div>
                        <div class="user-profile-actions" id="user-profile-actions"></div>
                    </div>
                </div>
                <h3 class="user-posts-title">Posts</h3>
                <div class="user-posts-container" id="user-posts-container"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCmIgFcDRapU6WigJSJCCgznV_cktlyAuI",
            authDomain: "my-app-e6c13.firebaseapp.com",
            projectId: "my-app-e6c13",
            storageBucket: "my-app-e6c13.appspot.com",
            messagingSenderId: "91681597709",
            appId: "1:91681597709:web:c1d4673df4fe48431d2844"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Generate a random user ID for the current session
        const currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
        let currentUserName = "User";
        let currentUserPicText = "U";
        let currentUserPhotoUrl = "";
        let currentUserColor = '#4285f4';
        let pendingFriendRequestsCount = 0;
        let onlineUsers = {};
        let userStatusInterval;
        let currentViewingUserId = null;

        // DOM Elements
        const homeView = document.getElementById('home-view');
        const chatView = document.getElementById('chat-view');
        const usersListView = document.getElementById('users-list-view');
        const friendsListView = document.getElementById('friends-list-view');
        const friendRequestsView = document.getElementById('friend-requests-view');
        const profileView = document.getElementById('profile-view');
        const userProfileView = document.getElementById('user-profile-view');
        
        // Navigation elements
        const navHome = document.getElementById('nav-home');
        const navChat = document.getElementById('nav-chat');
        const navFriends = document.getElementById('nav-friends');
        const navFriendRequests = document.getElementById('nav-friend-requests');
        const navProfile = document.getElementById('nav-profile');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const navMenu = document.getElementById('nav-menu');
        
        // Post elements
        const postCreator = document.getElementById('post-creator');
        const postInput = document.getElementById('post-input');
        const addImageBtn = document.getElementById('add-image-btn');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const postSubmitBtn = document.getElementById('post-submit-btn');
        const postsContainer = document.getElementById('posts-container');
        const createPostBtn = document.getElementById('create-post-btn');
        
        // Chat elements
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const chatTitle = document.getElementById('chat-title');
        const chatBackButton = document.getElementById('chat-back-button');
        const replyInfo = document.getElementById('reply-info');
        const replyToName = document.getElementById('reply-to-name');
        const cancelReply = document.getElementById('cancel-reply');
        
        // Users list elements
        const usersListContainer = document.getElementById('users-list-container');
        
        // Friends list elements
        const friendsListContainer = document.getElementById('friends-list-container');
        
        // Friend requests elements
        const friendRequestsContainer = document.getElementById('friend-requests-container');
        const friendRequestsBadge = document.getElementById('friend-requests-badge');
        
        // Profile elements
        const sidebarProfilePic = document.getElementById('sidebar-profile-pic');
        const sidebarProfileName = document.getElementById('sidebar-profile-name');
        const profilePhotoPreview = document.getElementById('profile-photo-preview');
        const profilePhotoUploadBtn = document.getElementById('profile-photo-upload-btn');
        const profilePhotoUpload = document.getElementById('profile-photo-upload');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileEmailInput = document.getElementById('profile-email-input');
        const profileSaveBtn = document.getElementById('profile-save-btn');
        
        // User profile elements
        const userProfilePic = document.getElementById('user-profile-pic');
        const userProfileName = document.getElementById('user-profile-name');
        const userProfileStatus = document.getElementById('user-profile-status');
        const userProfileActions = document.getElementById('user-profile-actions');
        const userPostsContainer = document.getElementById('user-posts-container');
        
        // State variables
        let currentPrivateChatUserId = null;
        let currentPrivateChatUserName = null;
        let selectedImageFile = null;
        let replyingToMessage = null;

        // Initialize the app
        function init() {
            // Register current user
            registerUser();
            
            loadUserData();
            setupEventListeners();
            loadPosts();
            loadPublicChatMessages();
            loadFriends();
            loadFriendRequests();
            
            // Set up online status tracking
            setupOnlineStatus();
            
            // Hide preview containers initially
            imagePreviewContainer.classList.add('hidden');
            
            // Show home view by default
            showView('home');
        }

        // Register user in Firestore
        function registerUser() {
            const userRef = db.collection("users").doc(currentUserId);
            
            userRef.set({
                id: currentUserId,
                name: currentUserName,
                color: currentUserColor,
                photoUrl: currentUserPhotoUrl || null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastOnline: firebase.firestore.FieldValue.serverTimestamp(),
                isOnline: true
            }, { merge: true }).catch(error => {
                console.error("Error registering user:", error);
            });
            
            // Set up real-time online status
            userRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    onlineUsers[userData.id] = userData;
                }
            });
        }

        // Set up online status tracking
        function setupOnlineStatus() {
            const userRef = db.collection("users").doc(currentUserId);
            
            // Update online status every 10 seconds
            userStatusInterval = setInterval(() => {
                userRef.update({
                    isOnline: true,
                    lastOnline: firebase.firestore.FieldValue.serverTimestamp()
                });
            }, 10000);
            
            // Set online status to false when user leaves
            window.addEventListener('beforeunload', () => {
                clearInterval(userStatusInterval);
                userRef.update({
                    isOnline: false,
                    lastOnline: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
        }

        // Load user data from Firestore
        function loadUserData() {
            const userRef = db.collection("users").doc(currentUserId);
            
            userRef.get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    currentUserName = userData.name || "User";
                    currentUserPicText = userData.name ? userData.name.charAt(0).toUpperCase() : "U";
                    currentUserColor = userData.color || '#4285f4';
                    currentUserPhotoUrl = userData.photoUrl || "";
                    
                    // Update sidebar profile
                    updateSidebarProfile();
                    
                    // Update profile editor
                    profileNameInput.value = currentUserName;
                    profileEmailInput.value = "user@example.com"; // Placeholder, would normally come from auth
                    
                    if (currentUserPhotoUrl) {
                        profilePhotoPreview.style.backgroundImage = `url(${currentUserPhotoUrl})`;
                        profilePhotoPreview.textContent = "";
                    } else {
                        profilePhotoPreview.textContent = currentUserPicText;
                        profilePhotoPreview.style.backgroundColor = currentUserColor;
                    }
                }
            }).catch(error => {
                console.error("Error loading user data:", error);
            });
        }

        // Update sidebar profile display
        function updateSidebarProfile() {
            sidebarProfileName.textContent = currentUserName;
            
            if (currentUserPhotoUrl) {
                sidebarProfilePic.style.backgroundImage = `url(${currentUserPhotoUrl})`;
                sidebarProfilePic.textContent = "";
            } else {
                sidebarProfilePic.textContent = currentUserPicText;
                sidebarProfilePic.style.backgroundColor = currentUserColor;
                sidebarProfilePic.style.backgroundImage = "";
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation
            navHome.addEventListener('click', (e) => {
                e.preventDefault();
                showView('home');
            });
            navChat.addEventListener('click', (e) => {
                e.preventDefault();
                showView('chat');
            });
            navFriends.addEventListener('click', (e) => {
                e.preventDefault();
                showView('friends');
            });
            navFriendRequests.addEventListener('click', (e) => {
                e.preventDefault();
                showView('friend-requests');
            });
            navProfile.addEventListener('click', (e) => {
                e.preventDefault();
                showView('profile');
            });
            
            // Mobile menu
            mobileMenuBtn.addEventListener('click', () => {
                navMenu.classList.toggle('active');
            });
            
            // Post creation
            createPostBtn.addEventListener('click', togglePostCreator);
            addImageBtn.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleImageUpload);
            removeImageBtn.addEventListener('click', removeImage);
            postSubmitBtn.addEventListener('click', createPost);
            
            // Chat
            chatSendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            chatBackButton.addEventListener('click', () => {
                currentPrivateChatUserId = null;
                currentPrivateChatUserName = null;
                chatTitle.textContent = "Public Chat";
                chatBackButton.style.display = 'none';
                loadPublicChatMessages();
            });
            
            // Reply functionality
            cancelReply.addEventListener('click', cancelReplyToMessage);
            
            // Profile
            profilePhotoUploadBtn.addEventListener('click', () => profilePhotoUpload.click());
            profilePhotoUpload.addEventListener('change', handleProfilePhotoUpload);
            profileSaveBtn.addEventListener('click', saveProfile);
        }

        // Show the specified view
        function showView(view) {
            // Hide all views
            homeView.style.display = 'none';
            chatView.style.display = 'none';
            usersListView.style.display = 'none';
            friendsListView.style.display = 'none';
            friendRequestsView.style.display = 'none';
            profileView.style.display = 'none';
            userProfileView.style.display = 'none';
            
            // Reset nav active states
            navHome.classList.remove('active');
            navChat.classList.remove('active');
            navFriends.classList.remove('active');
            navFriendRequests.classList.remove('active');
            navProfile.classList.remove('active');
            
            // Hide mobile menu
            navMenu.classList.remove('active');
            
            // Show the selected view and set active nav
            switch(view) {
                case 'home':
                    homeView.style.display = 'block';
                    navHome.classList.add('active');
                    break;
                case 'chat':
                    chatView.style.display = 'block';
                    usersListView.style.display = 'block';
                    navChat.classList.add('active');
                    loadUsersList();
                    loadPublicChatMessages();
                    break;
                case 'friends':
                    friendsListView.style.display = 'block';
                    navFriends.classList.add('active');
                    loadFriends();
                    break;
                case 'friend-requests':
                    friendRequestsView.style.display = 'block';
                    navFriendRequests.classList.add('active');
                    loadFriendRequests();
                    break;
                case 'profile':
                    profileView.style.display = 'block';
                    navProfile.classList.add('active');
                    break;
                case 'user-profile':
                    userProfileView.style.display = 'block';
                    break;
            }
        }

        // Toggle post creator visibility
        function togglePostCreator() {
            if (postCreator.classList.contains('hidden')) {
                postCreator.classList.remove('hidden');
                postInput.focus();
            } else {
                postCreator.classList.add('hidden');
                postInput.value = "";
                removeImage();
            }
        }

        // Handle image upload for posts
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                alert("Please select an image file");
                return;
            }
            
            selectedImageFile = file;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                imagePreview.src = event.target.result;
                imagePreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Remove selected image
        function removeImage() {
            selectedImageFile = null;
            imagePreview.src = "";
            imagePreviewContainer.classList.add('hidden');
            imageUpload.value = "";
        }

        // Create a new post
        function createPost() {
            const postText = postInput.value.trim();
            if (!postText && !selectedImageFile) {
                alert("Please enter text or add an image");
                return;
            }
            
            const postData = {
                userId: currentUserId,
                userName: currentUserName,
                userColor: currentUserColor,
                userPicText: currentUserPicText,
                userPhotoUrl: currentUserPhotoUrl || null,
                text: postText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                likes: {},
                comments: []
            };
            
            // For simplicity, we'll just store the image as a data URL
            // In a real app, you would upload to Firebase Storage
            if (selectedImageFile) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    postData.imageUrl = event.target.result;
                    savePostToFirestore(postData);
                };
                reader.readAsDataURL(selectedImageFile);
            } else {
                savePostToFirestore(postData);
            }
        }

        // Save post to Firestore
        function savePostToFirestore(postData) {
            db.collection("posts").add(postData)
                .then(() => {
                    postInput.value = "";
                    removeImage();
                    postCreator.classList.add('hidden');
                })
                .catch(error => {
                    console.error("Error creating post:", error);
                    alert("Error creating post. Please try again.");
                });
        }

        // Load posts from Firestore
        function loadPosts() {
            db.collection("posts")
                .orderBy("timestamp", "desc")
                .onSnapshot(snapshot => {
                    postsContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        postsContainer.innerHTML = '<div class="empty-state">No posts yet. Be the first to post!</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        post.id = doc.id;
                        renderPost(post);
                    });
                }, error => {
                    console.error("Error loading posts:", error);
                    postsContainer.innerHTML = '<div class="empty-state">Error loading posts</div>';
                });
        }

        // Render a single post
        function renderPost(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post';
            
            const timeAgo = getTimeAgo(post.timestamp.toDate());
            
            const userDisplay = post.userPhotoUrl 
                ? `<div class="profile-pic" style="background-image: url(${post.userPhotoUrl}); background-color: ${post.userColor || '#4285f4'}" onclick="showUserProfile('${post.userId}')"></div>`
                : `<div class="profile-pic" style="background-color: ${post.userColor || '#4285f4'}" onclick="showUserProfile('${post.userId}')">${post.userPicText || 'U'}</div>`;
            
            const isCurrentUserPost = post.userId === currentUserId;
            const likeCount = post.likes ? Object.keys(post.likes).length : 0;
            const isLiked = post.likes && post.likes[currentUserId];
            const commentCount = post.comments ? post.comments.length : 0;
            
            // Add online status indicator to post header
            const onlineStatus = onlineUsers[post.userId]?.isOnline ? 
                '<span class="online-status online" title="Online now"></span>' : 
                `<span class="online-status offline" title="Last online ${getLastOnlineText(onlineUsers[post.userId]?.lastOnline?.toDate())}"></span>`;
            
            postElement.innerHTML = `
                <div class="post-header">
                    ${userDisplay}
                    <div>
                        <div class="post-user">${post.userName || 'User'} ${onlineStatus}</div>
                        <div class="post-time">${timeAgo}</div>
                    </div>
                    ${isCurrentUserPost ? `<button class="delete-post" data-post-id="${post.id}">×</button>` : ''}
                </div>
                <div class="post-content">${post.text}</div>
                ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" alt="Post image" onerror="this.style.display='none'">` : ''}
                <div class="post-actions-bar">
                    <div class="post-action ${isLiked ? 'liked' : ''}" data-post-id="${post.id}" data-action="like">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span>Like</span>
                        ${likeCount > 0 ? `<span class="post-action-count">${likeCount}</span>` : ''}
                    </div>
                    <div class="post-action" data-post-id="${post.id}" data-action="comment">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <span>Comment</span>
                        ${commentCount > 0 ? `<span class="post-action-count">${commentCount}</span>` : ''}
                    </div>
                    <div class="post-action" data-post-id="${post.id}" data-action="share">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                        <span>Share</span>
                    </div>
                </div>
                <div class="comments-section" id="comments-${post.id}">
                    <div class="comments-list" id="comments-list-${post.id}">
                        ${post.comments && post.comments.length > 0 ? 
                            post.comments.map(comment => renderComment(comment)).join('') : 
                            '<div class="empty-state">No comments yet</div>'}
                    </div>
                    <div class="comment-input-container">
                        <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment...">
                        <button class="comment-button" data-post-id="${post.id}">Post</button>
                    </div>
                </div>
            `;
            
            // Add event listeners for post actions
            const likeBtn = postElement.querySelector('[data-action="like"]');
            likeBtn.addEventListener('click', () => toggleLike(post.id, post.likes || {}));
            
            const commentBtn = postElement.querySelector('[data-action="comment"]');
            commentBtn.addEventListener('click', () => {
                const commentInput = postElement.querySelector(`#comment-input-${post.id}`);
                commentInput.focus();
            });
            
            const commentInput = postElement.querySelector(`#comment-input-${post.id}`);
            const commentSubmitBtn = postElement.querySelector(`[data-post-id="${post.id}"]`);
            
            commentInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addComment(post.id, commentInput.value);
                    commentInput.value = "";
                }
            });
            
            commentSubmitBtn.addEventListener('click', () => {
                addComment(post.id, commentInput.value);
                commentInput.value = "";
            });
            
            if (isCurrentUserPost) {
                const deleteBtn = postElement.querySelector('.delete-post');
                deleteBtn.addEventListener('click', () => deletePost(post.id));
            }
            
            postsContainer.appendChild(postElement);
        }

        // Toggle like on a post
        function toggleLike(postId, likes) {
            const postRef = db.collection("posts").doc(postId);
            
            if (likes[currentUserId]) {
                // Unlike
                delete likes[currentUserId];
            } else {
                // Like
                likes[currentUserId] = true;
            }
            
            postRef.update({ likes })
                .catch(error => {
                    console.error("Error updating likes:", error);
                });
        }

        // Add a comment to a post
        function addComment(postId, commentText) {
            if (!commentText.trim()) return;
            
            const comment = {
                id: 'comment_' + Math.random().toString(36).substr(2, 9),
                userId: currentUserId,
                userName: currentUserName,
                userColor: currentUserColor,
                userPicText: currentUserPicText,
                userPhotoUrl: currentUserPhotoUrl || null,
                text: commentText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const postRef = db.collection("posts").doc(postId);
            
            postRef.get().then(doc => {
                if (doc.exists) {
                    const post = doc.data();
                    const comments = post.comments || [];
                    comments.push(comment);
                    
                    return postRef.update({ comments });
                }
            }).catch(error => {
                console.error("Error adding comment:", error);
            });
        }

        // Delete a post
        function deletePost(postId) {
            if (confirm("Are you sure you want to delete this post?")) {
                db.collection("posts").doc(postId).delete()
                    .catch(error => {
                        console.error("Error deleting post:", error);
                        alert("Error deleting post. Please try again.");
                    });
            }
        }

        // Render a single comment
        function renderComment(comment) {
            const timeAgo = comment.timestamp ? getTimeAgo(comment.timestamp.toDate()) : 'Just now';
            
            // Add online status indicator to comment
            const onlineStatus = onlineUsers[comment.userId]?.isOnline ? 
                '<span class="online-status online" title="Online now"></span>' : 
                `<span class="online-status offline" title="Last online ${getLastOnlineText(onlineUsers[comment.userId]?.lastOnline?.toDate())}"></span>`;
            
            return `
                <div class="comment" data-comment-id="${comment.id || ''}">
                    <div class="profile-pic" style="${comment.userPhotoUrl ? 
                        `background-image: url(${comment.userPhotoUrl})` : 
                        `background-color: ${comment.userColor || '#4285f4'}`}" onclick="showUserProfile('${comment.userId}')">
                        ${comment.userPhotoUrl ? '' : comment.userPicText || 'U'}
                    </div>
                    <div style="flex: 1;">
                        <div class="comment-user">${comment.userName || 'User'} ${onlineStatus}</div>
                        <div class="comment-content">${comment.text}</div>
                        <div class="comment-time">${timeAgo}</div>
                        <div class="comment-actions">
                            <span class="comment-action reply-btn">Reply</span>
                            ${comment.userId === currentUserId ? 
                                `<span class="comment-action delete-btn">Delete</span>` : ''}
                        </div>
                        <div class="comment-reply-input" id="reply-input-${comment.id || ''}">
                            <input type="text" class="comment-input" placeholder="Write a reply...">
                            <button class="comment-button" data-comment-id="${comment.id || ''}">Post</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load public chat messages
        function loadPublicChatMessages() {
            chatMessages.innerHTML = '';
            chatTitle.textContent = "Public Chat";
            chatBackButton.style.display = 'none';
            
            db.collection("publicChat")
                .orderBy("timestamp", "asc")
                .onSnapshot(snapshot => {
                    chatMessages.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        message.id = doc.id;
                        renderMessage(message);
                    });
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, error => {
                    console.error("Error loading public chat messages:", error);
                });
        }

        // Load private chat messages
        function loadPrivateChatMessages(userId) {
            chatMessages.innerHTML = '';
            
            // Get the conversation ID (sorted to ensure consistency)
            const conversationId = [currentUserId, userId].sort().join('_');
            
            db.collection("privateChats").doc(conversationId).collection("messages")
                .orderBy("timestamp", "asc")
                .onSnapshot(snapshot => {
                    chatMessages.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        message.id = doc.id;
                        renderMessage(message);
                    });
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, error => {
                    console.error("Error loading private chat messages:", error);
                });
        }

        // Render a single message
        function renderMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.userId === currentUserId ? 'current-user-message' : ''}`;
            messageElement.dataset.messageId = message.id;
            
            const timeAgo = message.timestamp ? getTimeAgo(message.timestamp.toDate()) : 'Just now';
            
            // Check if this message is a reply
            let replyContent = '';
            if (message.replyTo) {
                replyContent = `
                    <div class="reply-indicator">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 10 4 15 9 20"></polyline>
                            <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
                        </svg>
                        Replying to ${message.replyTo.userName}
                    </div>
                    <div class="reply-preview">
                        ${message.replyTo.text}
                    </div>
                `;
            }
            
            const userPic = message.userPhotoUrl 
                ? `<div class="profile-pic" style="background-image: url(${message.userPhotoUrl}); background-color: ${message.userColor || '#4285f4'}" onclick="showUserProfile('${message.userId}')"></div>`
                : `<div class="profile-pic" style="background-color: ${message.userColor || '#4285f4'}" onclick="showUserProfile('${message.userId}')">${message.userPicText || 'U'}</div>`;
            
            messageElement.innerHTML = `
                ${replyContent}
                <div class="message-sender">${message.userName || 'User'}</div>
                <div class="message-content">
                    ${message.text}
                    <div class="message-actions">
                        <button class="message-action reply-btn" title="Reply">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 10 4 15 9 20"></polyline>
                                <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
                            </svg>
                        </button>
                        ${message.userId === currentUserId ? `
                        <button class="message-action delete-btn" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                </div>
                <div class="message-time">${timeAgo}</div>
            `;
            
            // Add reply functionality
            const replyBtn = messageElement.querySelector('.reply-btn');
            replyBtn.addEventListener('click', () => replyToMessage(message));
            
            // Add delete functionality for current user's messages
            if (message.userId === currentUserId) {
                const deleteBtn = messageElement.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', () => deleteMessage(message));
            }
            
            chatMessages.appendChild(messageElement);
        }

        // Reply to a message
        function replyToMessage(message) {
            replyingToMessage = message;
            replyInfo.classList.remove('hidden');
            replyToName.textContent = message.userName;
            chatInput.focus();
        }

        // Cancel reply
        function cancelReplyToMessage() {
            replyingToMessage = null;
            replyInfo.classList.add('hidden');
        }

        // Delete a message
        function deleteMessage(message) {
            if (!confirm("Are you sure you want to delete this message?")) return;
            
            if (currentPrivateChatUserId) {
                // Delete private message
                const conversationId = [currentUserId, currentPrivateChatUserId].sort().join('_');
                db.collection("privateChats").doc(conversationId).collection("messages").doc(message.id).delete()
                    .catch(error => {
                        console.error("Error deleting message:", error);
                    });
            } else {
                // Delete public message
                db.collection("publicChat").doc(message.id).delete()
                    .catch(error => {
                        console.error("Error deleting message:", error);
                    });
            }
        }

        // Send a message
        function sendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText) return;
            
            const message = {
                userId: currentUserId,
                userName: currentUserName,
                userColor: currentUserColor,
                userPicText: currentUserPicText,
                userPhotoUrl: currentUserPhotoUrl || null,
                text: messageText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // If replying to a message, add reply info
            if (replyingToMessage) {
                message.replyTo = {
                    userId: replyingToMessage.userId,
                    userName: replyingToMessage.userName,
                    text: replyingToMessage.text,
                    messageId: replyingToMessage.id
                };
            }
            
            if (currentPrivateChatUserId) {
                // Private message
                const conversationId = [currentUserId, currentPrivateChatUserId].sort().join('_');
                
                db.collection("privateChats").doc(conversationId).collection("messages").add(message)
                    .then(() => {
                        chatInput.value = "";
                        cancelReplyToMessage();
                    })
                    .catch(error => {
                        console.error("Error sending private message:", error);
                    });
            } else {
                // Public message
                db.collection("publicChat").add(message)
                    .then(() => {
                        chatInput.value = "";
                        cancelReplyToMessage();
                    })
                    .catch(error => {
                        console.error("Error sending public message:", error);
                    });
            }
        }

        // Load users list for private chat (only online users)
        function loadUsersList() {
            db.collection("users")
                .where("isOnline", "==", true)
                .where("id", "!=", currentUserId)
                .get()
                .then(usersSnapshot => {
                    usersListContainer.innerHTML = '';
                    
                    if (usersSnapshot.empty) {
                        usersListContainer.innerHTML = '<div class="empty-state">No other users online</div>';
                        return;
                    }
                    
                    // Get all friendships where current user is involved
                    db.collection("friendships")
                        .where("users", "array-contains", currentUserId)
                        .get()
                        .then(friendshipsSnapshot => {
                            const friendships = {};
                            friendshipsSnapshot.forEach(doc => {
                                const friendship = doc.data();
                                const friendId = friendship.users.find(id => id !== currentUserId);
                                friendships[friendId] = {
                                    status: friendship.status,
                                    requestedBy: friendship.requestedBy
                                };
                            });
                            
                            usersSnapshot.forEach(userDoc => {
                                const user = userDoc.data();
                                const userId = user.id;
                                
                                // Check friendship status
                                let friendshipStatus = "not_friends";
                                if (friendships[userId]) {
                                    if (friendships[userId].status === "accepted") {
                                        friendshipStatus = "accepted";
                                    } else if (friendships[userId].status === "pending") {
                                        if (friendships[userId].requestedBy === currentUserId) {
                                            friendshipStatus = "pending_sent";
                                        } else {
                                            friendshipStatus = "pending_received";
                                        }
                                    }
                                }
                                
                                renderUserListItem(user, userId, friendshipStatus);
                            });
                        })
                        .catch(error => {
                            console.error("Error loading friendships:", error);
                            usersListContainer.innerHTML = '<div class="empty-state">Error loading users</div>';
                        });
                })
                .catch(error => {
                    console.error("Error loading users:", error);
                    usersListContainer.innerHTML = '<div class="empty-state">Error loading users</div>';
                });
        }

        // Render a single user in the users list with online status
        function renderUserListItem(user, userId, friendshipStatus) {
            const userElement = document.createElement('div');
            userElement.className = 'user-item';
            userElement.dataset.userId = userId;
            
            const userPic = user.photoUrl 
                ? `<div class="profile-pic" style="background-image: url(${user.photoUrl})" onclick="showUserProfile('${userId}')"></div>`
                : `<div class="profile-pic" style="background-color: ${user.color || '#4285f4'}" onclick="showUserProfile('${userId}')">${user.name.charAt(0).toUpperCase()}</div>`;
            
            // Online status indicator
            const onlineStatus = user.isOnline ? 
                '<span class="online-status online"></span>' : 
                '<span class="online-status offline"></span>';
            
            let statusHtml = '';
            if (friendshipStatus === "accepted") {
                statusHtml = '<div class="friend-status friends">Friends</div>';
            } else if (friendshipStatus === "pending_sent") {
                statusHtml = '<div class="friend-status pending">Request Sent</div>';
            } else if (friendshipStatus === "pending_received") {
                statusHtml = '<div class="friend-status pending">Request Received</div>';
            } else {
                statusHtml = `<button class="friend-status add" data-user-id="${userId}">Add Friend</button>`;
            }
            
            userElement.innerHTML = `
                ${userPic}
                <div>
                    <div>${user.name} ${onlineStatus}</div>
                    <div class="last-online">${getLastOnlineText(user.lastOnline?.toDate())}</div>
                </div>
                ${statusHtml}
            `;
            
            if (friendshipStatus === "accepted") {
                userElement.addEventListener('click', () => {
                    currentPrivateChatUserId = userId;
                    currentPrivateChatUserName = user.name;
                    chatTitle.textContent = `Chat with ${user.name}`;
                    chatBackButton.style.display = 'block';
                    
                    // Clear any existing status element
                    const existingStatus = document.querySelector('.user-status');
                    if (existingStatus) {
                        existingStatus.remove();
                    }
                    
                    // Add online status to chat header
                    const statusElement = document.createElement('div');
                    statusElement.className = 'user-status';
                    statusElement.innerHTML = `
                        <span class="online-status ${user.isOnline ? 'online' : 'offline'}"></span>
                        ${user.isOnline ? 
                            '<span class="active-now"><span class="pulse"></span>Active now</span>' : 
                            `Last online ${getLastOnlineText(user.lastOnline?.toDate())}`}
                    `;
                    
                    // Insert after chat title
                    chatTitle.parentNode.insertBefore(statusElement, chatTitle.nextSibling);
                    
                    loadPrivateChatMessages(userId);
                });
            }
            
            const addFriendBtn = userElement.querySelector('.add');
            if (addFriendBtn) {
                addFriendBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sendFriendRequest(userId, user.name);
                });
            }
            
            usersListContainer.appendChild(userElement);
        }

        // Load friends list
        function loadFriends() {
            db.collection("friendships")
                .where("users", "array-contains", currentUserId)
                .where("status", "==", "accepted")
                .get()
                .then(friendshipsSnapshot => {
                    friendsListContainer.innerHTML = '';
                    
                    if (friendshipsSnapshot.empty) {
                        friendsListContainer.innerHTML = '<div class="empty-state">No friends yet</div>';
                        return;
                    }
                    
                    const friendIds = [];
                    friendshipsSnapshot.forEach(doc => {
                        const friendship = doc.data();
                        const friendId = friendship.users.find(id => id !== currentUserId);
                        friendIds.push(friendId);
                    });
                    
                    if (friendIds.length === 0) {
                        friendsListContainer.innerHTML = '<div class="empty-state">No friends yet</div>';
                        return;
                    }
                    
                    // Get all friend user data
                    db.collection("users")
                        .where("id", "in", friendIds)
                        .get()
                        .then(usersSnapshot => {
                            usersSnapshot.forEach(userDoc => {
                                const user = userDoc.data();
                                renderFriend(user, user.id);
                            });
                        })
                        .catch(error => {
                            console.error("Error loading friends data:", error);
                            friendsListContainer.innerHTML = '<div class="empty-state">Error loading friends</div>';
                        });
                })
                .catch(error => {
                    console.error("Error loading friends:", error);
                    friendsListContainer.innerHTML = '<div class="empty-state">Error loading friends</div>';
                });
        }

        // Render a single friend with online status
        function renderFriend(friend, friendId) {
            const friendElement = document.createElement('div');
            friendElement.className = 'user-item';
            friendElement.dataset.userId = friendId;
            
            const friendPic = friend.photoUrl 
                ? `<div class="profile-pic" style="background-image: url(${friend.photoUrl})" onclick="showUserProfile('${friendId}')"></div>`
                : `<div class="profile-pic" style="background-color: ${friend.color || '#4285f4'}" onclick="showUserProfile('${friendId}')">${friend.name.charAt(0).toUpperCase()}</div>`;
            
            // Online status indicator
            const onlineStatus = friend.isOnline ? 
                '<span class="online-status online"></span>' : 
                '<span class="online-status offline"></span>';
            
            friendElement.innerHTML = `
                ${friendPic}
                <div>
                    <div>${friend.name} ${onlineStatus}</div>
                    <div class="last-online">${getLastOnlineText(friend.lastOnline?.toDate())}</div>
                </div>
                <div class="friend-status friends">Friends</div>
            `;
            
            friendElement.addEventListener('click', () => {
                currentPrivateChatUserId = friendId;
                currentPrivateChatUserName = friend.name;
                chatTitle.textContent = `Chat with ${friend.name}`;
                chatBackButton.style.display = 'block';
                
                // Clear any existing status element
                const existingStatus = document.querySelector('.user-status');
                if (existingStatus) {
                    existingStatus.remove();
                }
                
                // Add online status to chat header
                const statusElement = document.createElement('div');
                statusElement.className = 'user-status';
                statusElement.innerHTML = `
                    <span class="online-status ${friend.isOnline ? 'online' : 'offline'}"></span>
                    ${friend.isOnline ? 
                        '<span class="active-now"><span class="pulse"></span>Active now</span>' : 
                        `Last online ${getLastOnlineText(friend.lastOnline?.toDate())}`}
                `;
                
                // Insert after chat title
                chatTitle.parentNode.insertBefore(statusElement, chatTitle.nextSibling);
                
                loadPrivateChatMessages(friendId);
            });
            
            friendsListContainer.appendChild(friendElement);
        }

        // Load friend requests
        function loadFriendRequests() {
            db.collection("friendships")
                .where("users", "array-contains", currentUserId)
                .where("status", "==", "pending")
                .get()
                .then(friendshipsSnapshot => {
                    friendRequestsContainer.innerHTML = '';
                    pendingFriendRequestsCount = 0;
                    
                    if (friendshipsSnapshot.empty) {
                        friendRequestsContainer.innerHTML = '<div class="empty-state">No pending friend requests</div>';
                        friendRequestsBadge.classList.add('hidden');
                        return;
                    }
                    
                    const requestUserIds = [];
                    friendshipsSnapshot.forEach(doc => {
                        const friendship = doc.data();
                        const requesterId = friendship.users.find(id => id !== currentUserId);
                        if (friendship.requestedBy === requesterId) {
                            requestUserIds.push(requesterId);
                            pendingFriendRequestsCount++;
                        }
                    });
                    
                    if (requestUserIds.length === 0) {
                        friendRequestsContainer.innerHTML = '<div class="empty-state">No pending friend requests</div>';
                        friendRequestsBadge.classList.add('hidden');
                        return;
                    }
                    
                    // Update badge
                    friendRequestsBadge.textContent = pendingFriendRequestsCount;
                    friendRequestsBadge.classList.remove('hidden');
                    
                    // Get all requesters' user data
                    db.collection("users")
                        .where("id", "in", requestUserIds)
                        .get()
                        .then(usersSnapshot => {
                            usersSnapshot.forEach(userDoc => {
                                const user = userDoc.data();
                                renderFriendRequest(user, user.id);
                            });
                        })
                        .catch(error => {
                            console.error("Error loading requesters data:", error);
                            friendRequestsContainer.innerHTML = '<div class="empty-state">Error loading requests</div>';
                        });
                })
                .catch(error => {
                    console.error("Error loading friend requests:", error);
                    friendRequestsContainer.innerHTML = '<div class="empty-state">Error loading friend requests</div>';
                });
        }

        // Render a single friend request
        function renderFriendRequest(user, userId) {
            const requestElement = document.createElement('div');
            requestElement.className = 'friend-request';
            
            const userPic = user.photoUrl 
                ? `<div class="profile-pic" style="background-image: url(${user.photoUrl})" onclick="showUserProfile('${userId}')"></div>`
                : `<div class="profile-pic" style="background-color: ${user.color || '#4285f4'}" onclick="showUserProfile('${userId}')">${user.name.charAt(0).toUpperCase()}</div>`;
            
            requestElement.innerHTML = `
                ${userPic}
                <div>
                    <div>${user.name}</div>
                    <div class="last-online">${getLastOnlineText(user.lastOnline?.toDate())}</div>
                </div>
                <div class="friend-request-actions">
                    <button class="friend-request-btn accept-btn" data-user-id="${userId}">Accept</button>
                    <button class="friend-request-btn reject-btn" data-user-id="${userId}">Reject</button>
                </div>
            `;
            
            const acceptBtn = requestElement.querySelector('.accept-btn');
            acceptBtn.addEventListener('click', () => respondToFriendRequest(userId, 'accept'));
            
            const rejectBtn = requestElement.querySelector('.reject-btn');
            rejectBtn.addEventListener('click', () => respondToFriendRequest(userId, 'reject'));
            
            friendRequestsContainer.appendChild(requestElement);
        }

        // Send friend request
        function sendFriendRequest(userId, userName) {
            const friendshipId = [currentUserId, userId].sort().join('_');
            
            db.collection("friendships").doc(friendshipId).set({
                users: [currentUserId, userId],
                status: "pending",
                requestedBy: currentUserId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                alert(`Friend request sent to ${userName}`);
                loadUsersList();
                loadFriendRequests();
            })
            .catch(error => {
                console.error("Error sending friend request:", error);
                alert("Error sending friend request. Please try again.");
            });
        }

        // Respond to friend request
        function respondToFriendRequest(userId, response) {
            const friendshipId = [currentUserId, userId].sort().join('_');
            
            if (response === 'accept') {
                db.collection("friendships").doc(friendshipId).update({
                    status: "accepted",
                    acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    loadFriendRequests();
                    loadFriends();
                    loadUsersList();
                })
                .catch(error => {
                    console.error("Error accepting friend request:", error);
                });
            } else {
                db.collection("friendships").doc(friendshipId).delete()
                .then(() => {
                    loadFriendRequests();
                    loadUsersList();
                })
                .catch(error => {
                    console.error("Error rejecting friend request:", error);
                });
            }
        }

        // Show user profile
        function showUserProfile(userId) {
            if (userId === currentUserId) {
                showView('profile');
                return;
            }
            
            currentViewingUserId = userId;
            showView('user-profile');
            
            // Load user data
            db.collection("users").doc(userId).get().then(doc => {
                if (doc.exists) {
                    const user = doc.data();
                    
                    // Update profile header
                    if (user.photoUrl) {
                        userProfilePic.style.backgroundImage = `url(${user.photoUrl})`;
                        userProfilePic.textContent = "";
                    } else {
                        userProfilePic.textContent = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                        userProfilePic.style.backgroundColor = user.color || '#4285f4';
                        userProfilePic.style.backgroundImage = "";
                    }
                    
                    userProfileName.textContent = user.name || 'User';
                    
                    // Update online status
                    const onlineStatus = user.isOnline ? 
                        '<span class="online-status online"></span> <span class="active-now"><span class="pulse"></span>Active now</span>' : 
                        `<span class="online-status offline"></span> Last online ${getLastOnlineText(user.lastOnline?.toDate())}`;
                    
                    userProfileStatus.innerHTML = onlineStatus;
                    
                    // Check friendship status
                    const friendshipId = [currentUserId, userId].sort().join('_');
                    db.collection("friendships").doc(friendshipId).get().then(friendshipDoc => {
                        let actionHtml = '';
                        
                        if (!friendshipDoc.exists) {
                            // Not friends - show add friend button
                            actionHtml = `
                                <button class="user-profile-action-btn primary" onclick="sendFriendRequest('${userId}', '${user.name}')">
                                    Add Friend
                                </button>
                            `;
                        } else {
                            const friendship = friendshipDoc.data();
                            
                            if (friendship.status === "pending") {
                                if (friendship.requestedBy === currentUserId) {
                                    // Request sent
                                    actionHtml = `
                                        <button class="user-profile-action-btn secondary" disabled>
                                            Request Sent
                                        </button>
                                    `;
                                } else {
                                    // Request received
                                    actionHtml = `
                                        <button class="user-profile-action-btn primary" onclick="respondToFriendRequest('${userId}', 'accept')">
                                            Accept Request
                                        </button>
                                        <button class="user-profile-action-btn secondary" onclick="respondToFriendRequest('${userId}', 'reject')">
                                            Reject
                                        </button>
                                    `;
                                }
                            } else if (friendship.status === "accepted") {
                                // Friends
                                actionHtml = `
                                    <button class="user-profile-action-btn secondary" disabled>
                                        Friends
                                    </button>
                                    <button class="user-profile-action-btn primary" onclick="startPrivateChat('${userId}', '${user.name}')">
                                        Message
                                    </button>
                                `;
                            }
                        }
                        
                        userProfileActions.innerHTML = actionHtml;
                    });
                    
                    // Load user's posts
                    db.collection("posts")
                        .where("userId", "==", userId)
                        .orderBy("timestamp", "desc")
                        .get()
                        .then(snapshot => {
                            userPostsContainer.innerHTML = '';
                            
                            if (snapshot.empty) {
                                userPostsContainer.innerHTML = '<div class="empty-state">No posts yet</div>';
                                return;
                            }
                            
                            snapshot.forEach(doc => {
                                const post = doc.data();
                                post.id = doc.id;
                                renderUserPost(post);
                            });
                        });
                }
            });
        }

        // Render a single post in user profile
        function renderUserPost(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post';
            
            const timeAgo = getTimeAgo(post.timestamp.toDate());
            
            postElement.innerHTML = `
                <div class="post-header">
                    <div>
                        <div class="post-time">${timeAgo}</div>
                    </div>
                </div>
                <div class="post-content">${post.text}</div>
                ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" alt="Post image" onerror="this.style.display='none'">` : ''}
                <div class="post-actions-bar">
                    <div class="post-action">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span>Like</span>
                    </div>
                    <div class="post-action">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <span>Comment</span>
                    </div>
                </div>
            `;
            
            userPostsContainer.appendChild(postElement);
        }

        // Start private chat with user
        function startPrivateChat(userId, userName) {
            currentPrivateChatUserId = userId;
            currentPrivateChatUserName = userName;
            
            // Switch to chat view
            showView('chat');
            
            // Update chat header
            chatTitle.textContent = `Chat with ${userName}`;
            chatBackButton.style.display = 'block';
            
            // Clear any existing status element
            const existingStatus = document.querySelector('.user-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            // Load user status
            db.collection("users").doc(userId).get().then(doc => {
                if (doc.exists) {
                    const user = doc.data();
                    
                    // Add online status to chat header
                    const statusElement = document.createElement('div');
                    statusElement.className = 'user-status';
                    statusElement.innerHTML = `
                        <span class="online-status ${user.isOnline ? 'online' : 'offline'}"></span>
                        ${user.isOnline ? 
                            '<span class="active-now"><span class="pulse"></span>Active now</span>' : 
                            `Last online ${getLastOnlineText(user.lastOnline?.toDate())}`}
                    `;
                    
                    // Insert after chat title
                    chatTitle.parentNode.insertBefore(statusElement, chatTitle.nextSibling);
                }
            });
            
            // Load private messages
            loadPrivateChatMessages(userId);
        }

        // Handle profile photo upload
        function handleProfilePhotoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                alert("Please select an image file");
                return;
            }
            
            // For simplicity, we'll just store the image as a data URL
            // In a real app, you would upload to Firebase Storage
            const reader = new FileReader();
            reader.onload = (event) => {
                currentUserPhotoUrl = event.target.result;
                profilePhotoPreview.style.backgroundImage = `url(${currentUserPhotoUrl})`;
                profilePhotoPreview.textContent = "";
            };
            reader.readAsDataURL(file);
        }

        // Save profile changes
        function saveProfile() {
            const newName = profileNameInput.value.trim();
            if (!newName) {
                alert("Please enter your name");
                return;
            }
            
            currentUserName = newName;
            currentUserPicText = newName.charAt(0).toUpperCase();
            
            // Update user in Firestore
            db.collection("users").doc(currentUserId).update({
                name: currentUserName,
                photoUrl: currentUserPhotoUrl || null
            })
            .then(() => {
                updateSidebarProfile();
                alert("Profile updated successfully");
            })
            .catch(error => {
                console.error("Error updating profile:", error);
                alert("Error updating profile. Please try again.");
            });
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            if (!date) return "Just now";
            
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60,
                second: 1
            };
            
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
                }
            }
            
            return "Just now";
        }

        // Get last online text
        function getLastOnlineText(lastOnlineDate) {
            if (!lastOnlineDate) return "Never online";
            
            const now = new Date();
            const diffInSeconds = Math.floor((now - lastOnlineDate) / 1000);
            
            if (diffInSeconds < 60) {
                return "Online now";
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `Online ${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `Online ${hours} hour${hours !== 1 ? 's' : ''} ago`;
            } else if (diffInSeconds < 604800) {
                const days = Math.floor(diffInSeconds / 86400);
                return `Online ${days} day${days !== 1 ? 's' : ''} ago`;
            } else {
                return lastOnlineDate.toLocaleDateString();
            }
        }

        // Initialize the app
        init();
    </script>
</body>
</html>